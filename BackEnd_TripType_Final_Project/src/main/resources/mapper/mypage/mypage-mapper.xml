<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="mypageMapper">
	
	<resultMap id="WishItemResultMap" type="WishItemDto">
	    <id     property="flightOfferId"      column="FLIGHT_OFFER_ID"/>
	    <result property="departAirportCode"  column="DEPART_AIRPORT_CODE"/>
	    <result property="arriveAirportCode"  column="ARRIVE_AIRPORT_CODE"/>
	    <result property="tripType"            column="TRIP_TYPE"/>
	    <result property="departDate"          column="DEPART_DATE"/>
	    <result property="returnDate"          column="RETURN_DATE"/>
	    <result property="totalPrice"          column="TOTAL_PRICE"/>
	</resultMap>
	
	<select id="selectMyProfile" parameterType="Int" resultType="MyProfileRes">
		
		  SELECT
		    MEMBER_ID AS memberId,
		    MEMBER_NAME AS memberName,
		    MEMBER_BIRTH_DATE AS memberBirthDate,
		    MEMBER_GENDER AS memberGender,
		    MEMBER_PHONE AS memberPhone,
		    MEMBER_CREATE_AT AS memberCreateAt,
		    MEMBER_LAST_LOGIN_AT AS memberLastLoginAt,
		    CASE WHEN MEMBER_PASSWORD IS NULL THEN 0 ELSE 1 END AS hasPassword
		    FROM TB_MEMBER
		   WHERE MEMBER_NO = #{memberNo}
		     AND MEMBER_IS_ACTIVE = 'Y'
	</select>
	
	<update id="updateMyProfile">
	  UPDATE TB_MEMBER
	  SET
	    MEMBER_NAME = #{req.memberName},
	    MEMBER_BIRTH_DATE = #{req.memberBirthDate},
	    MEMBER_GENDER = #{req.memberGender},
	    MEMBER_PHONE = #{req.memberPhone}
	     WHERE MEMBER_NO = #{memberNo}
	       AND MEMBER_IS_ACTIVE = 'Y'
	</update>
	
	<select id="selectPassword" parameterType="int" resultType="String">
	  SELECT MEMBER_PASSWORD
	    FROM TB_MEMBER
	   WHERE MEMBER_NO = #{memberNo}
	     AND MEMBER_IS_ACTIVE = 'Y'
	</select>
	
	<update id="updatePassword">
	  UPDATE TB_MEMBER
	     SET MEMBER_PASSWORD = #{password}
	   WHERE MEMBER_NO = #{memberNo}
	</update>
	
	<update id="withdrawMember">
	  UPDATE TB_MEMBER
	  SET
	    MEMBER_IS_ACTIVE = 'N',
	    MEMBER_WITHDRAWN_AT = SYSDATE
	  WHERE MEMBER_NO = #{memberNo}
	    AND MEMBER_IS_ACTIVE = 'Y'
	</update>
	
	<select id="fetchSearchHistory" parameterType="int" resultType="SearchHistoryDto">
		SELECT
			SEARCH_LOG_NO AS searchLogNo,
		    DEPART_IATA_CODE AS departIata,
		    ARRIVE_IATA_CODE AS arriveIata,
		    SEARCH_LOG_DEPART_DATE AS departDate,
		    SEARCH_LOG_RETURN_DATE AS returnDate,
		    SEARCH_LOG_PASSENGER_COUNT AS passengerCount,
		    SEARCH_LOG_DATE AS searchLogDate,
		    MEMBER_NO AS memberNo
		  FROM TB_SEARCH_LOG    
		WHERE MEMBER_NO = #{memberNo}
		ORDER BY SEARCH_LOG_DATE DESC
	</select>
	
	<select id="selectWishlist"
	        parameterType="int"
	        resultMap="WishItemResultMap">
	
	    SELECT
	        w.FLIGHT_OFFER_ID                    AS FLIGHT_OFFER_ID,
	
	        ph.DEPART_IATA_CODE                  AS DEPART_AIRPORT_CODE,
	        ph.ARRIVE_IATA_CODE                  AS ARRIVE_AIRPORT_CODE,
	
	        CASE
	            WHEN o.FLIGHT_OFFER_ONE_WAY = 'Y'
	                THEN 'ONEWAY'
	            ELSE 'ROUND'
	        END                                  AS TRIP_TYPE,
	
	        TO_CHAR(o.FLIGHT_OFFER_DEPART_DATE, 'YYYY-MM-DD')
	                                             AS DEPART_DATE,
	
	        TO_CHAR(o.FLIGHT_OFFER_RETURN_DATE, 'YYYY-MM-DD')
	                                             AS RETURN_DATE,
	
	        ph.FLIGHT_OFFER_PRICE_TOTAL          AS TOTAL_PRICE
	
	    FROM TB_WISHLIST w
	
	    JOIN TB_FLIGHT_OFFER o
	      ON o.FLIGHT_OFFER_ID = w.FLIGHT_OFFER_ID
	     AND o.FLIGHT_OFFER_IS_DEL = 'N'
	
	    LEFT JOIN (
	        SELECT
	            FLIGHT_OFFER_ID,
	            FLIGHT_OFFER_PRICE_TOTAL,
	            DEPART_IATA_CODE,
	            ARRIVE_IATA_CODE
	        FROM (
	            SELECT
	                FLIGHT_OFFER_ID,
	                FLIGHT_OFFER_PRICE_TOTAL,
	                DEPART_IATA_CODE,
	                ARRIVE_IATA_CODE,
	                ROW_NUMBER() OVER (
	                    PARTITION BY FLIGHT_OFFER_ID
	                    ORDER BY FLIGHT_OFFER_API_QUERY_DATE DESC
	                ) rn
	            FROM TB_FLIGHT_PRICE_HISTORY
	        )
	        WHERE rn = 1
	    ) ph
	      ON ph.FLIGHT_OFFER_ID = o.FLIGHT_OFFER_ID
	
	    WHERE w.MEMBER_NO = #{memberNo}
	
	    ORDER BY o.FLIGHT_OFFER_DEPART_DATE DESC
	
	</select>



</mapper>