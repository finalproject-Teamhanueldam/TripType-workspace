<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="adminMemberMapper">

  <!-- =========================
       관리자 회원 목록
  ========================= -->
	<select id="selectMemberList"
	        resultType="AdminMember">
	
	  SELECT
	    m.MEMBER_NO            AS memberNo,
	    m.MEMBER_ID            AS memberId,
	    m.MEMBER_NAME          AS memberName,
	    m.MEMBER_BIRTH_DATE    AS memberBirthDate,
	    m.MEMBER_PHONE         AS memberPhone,
	    m.MEMBER_ROLE          AS memberRole,
	    m.MEMBER_IS_ACTIVE     AS memberIsActive,
	    m.MEMBER_IS_LOCKED     AS memberIsLocked,
	    m.MEMBER_CREATE_AT    AS memberCreateAt,
	    m.MEMBER_LAST_LOGIN_AT AS memberLastLoginAt,
	
	    CASE
	      WHEN COUNT(sa.SOCIAL_ACCOUNT_NO) > 0 THEN 'Y'
	      ELSE 'N'
	    END AS isSocial,
	
	    CASE
	      WHEN m.MEMBER_PASSWORD IS NOT NULL THEN 'Y'
	      ELSE 'N'
	    END AS hasPassword,	
	    	
	    LISTAGG(sa.SOCIAL_PROVIDER, ', ')
	      WITHIN GROUP (ORDER BY sa.SOCIAL_PROVIDER)
	      AS socialProviders
	
	  FROM TB_MEMBER m
	  LEFT JOIN TB_SOCIAL_ACCOUNT sa
	    ON m.MEMBER_NO = sa.MEMBER_NO
	
	  WHERE 1=1
	
	  <if test="keyword != null and keyword != ''">
	    AND (
	      m.MEMBER_ID LIKE '%' || #{keyword} || '%'
	      OR m.MEMBER_NAME LIKE '%' || #{keyword} || '%'
	    )
	  </if>
	
	  <if test="showInactive == false">
	    AND m.MEMBER_IS_ACTIVE = 'Y'
	  </if>
	
	  GROUP BY
	    m.MEMBER_NO,
	    m.MEMBER_ID,
	    m.MEMBER_NAME,
	    m.MEMBER_BIRTH_DATE,
	    m.MEMBER_PHONE,
	    m.MEMBER_ROLE,
	    m.MEMBER_IS_ACTIVE,
	    m.MEMBER_IS_LOCKED,
	    m.MEMBER_CREATE_AT,
	    m.MEMBER_LAST_LOGIN_AT,
	    m.MEMBER_PASSWORD
	
	  ORDER BY m.MEMBER_CREATE_AT DESC
	</select>

  <!-- =========================
       관리자 회원 상세
  ========================= -->
	<select id="selectMemberDetail"
	        parameterType="int"
	        resultType="AdminMember">
	
	  SELECT
	    m.MEMBER_NO            AS memberNo,
	    m.MEMBER_ID            AS memberId,
	    m.MEMBER_NAME          AS memberName,
	    m.MEMBER_BIRTH_DATE    AS memberBirthDate,
	    m.MEMBER_PHONE         AS memberPhone,
	    m.MEMBER_ROLE          AS memberRole,
	    m.MEMBER_IS_ACTIVE     AS memberIsActive,
	    m.MEMBER_IS_LOCKED     AS memberIsLocked,
	    m.MEMBER_CREATE_AT    AS memberCreateAt,
	    m.MEMBER_LAST_LOGIN_AT AS memberLastLoginAt,
		
	    CASE
	      WHEN COUNT(sa.SOCIAL_ACCOUNT_NO) > 0 THEN 'Y'
	      ELSE 'N'
	    END AS isSocial,
	    
	    CASE
	      WHEN m.MEMBER_PASSWORD IS NOT NULL THEN 'Y'
	      ELSE 'N'
	    END AS hasPassword,
	
	    LISTAGG(sa.SOCIAL_PROVIDER, ', ')
	      WITHIN GROUP (ORDER BY sa.SOCIAL_PROVIDER)
	      AS socialProviders
	
	  FROM TB_MEMBER m
	  LEFT JOIN TB_SOCIAL_ACCOUNT sa
	    ON m.MEMBER_NO = sa.MEMBER_NO
	
	  WHERE m.MEMBER_NO = #{memberNo}
	
	  GROUP BY
	    m.MEMBER_NO,
	    m.MEMBER_ID,
	    m.MEMBER_NAME,
	    m.MEMBER_BIRTH_DATE,
	    m.MEMBER_PHONE,
	    m.MEMBER_ROLE,
	    m.MEMBER_IS_ACTIVE,
	    m.MEMBER_IS_LOCKED,
	    m.MEMBER_CREATE_AT,
	    m.MEMBER_LAST_LOGIN_AT,
	    m.MEMBER_PASSWORD
	</select>

  <!-- =========================
       잠금 해제
  ========================= -->
  <update id="unlockMembers">
    UPDATE TB_MEMBER
       SET MEMBER_IS_LOCKED = 'N',
           MEMBER_LOGIN_FAIL_COUNT = 0
     WHERE MEMBER_NO IN
    <foreach collection="list"
             item="no"
             open="("
             close=")"
             separator=",">
      #{no}
    </foreach>
  </update>

  <!-- =========================
       비활성화 (탈퇴, 자진 탈퇴는 아님)
  ========================= -->
  <update id="deactivateMembers">
    UPDATE TB_MEMBER
       SET MEMBER_IS_ACTIVE = 'N'
     WHERE MEMBER_NO IN
    <foreach collection="list"
             item="no"
             open="("
             close=")"
             separator=",">
      #{no}
    </foreach>
  </update>

  <select id="selectAdminMemberNos" resultType="int">
    SELECT MEMBER_NO
    FROM TB_MEMBER
    WHERE MEMBER_NO IN
    <foreach collection="list"
             item="no"
             open="("
             close=")"
             separator=",">
        #{no}
    </foreach>
    AND MEMBER_ROLE = 'ADMIN'
  </select>

</mapper>
