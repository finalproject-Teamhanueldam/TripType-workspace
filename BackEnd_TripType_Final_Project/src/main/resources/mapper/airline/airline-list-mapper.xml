<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "mybatis-3-mapper.dtd">
  <mapper namespace="airlineList">
	<resultMap id="AirlineListResultMap" type="AirlineList">
	    <id property="flightNumber" column="FLIGHT_NUMBER"/>
	    <result property="airlineName" column="AIRLINE_AIRLINE_NAME"/>
	    <result property="flightNumber" column="FLIGHT_NUMBER"/>
	
	    <result property="departDate" column="FLIGHT_DEPART_DATE"/>
	    <result property="departCity" column="DEPART_CITY"/>
	    <result property="departAirportCode" column="DEPART_CODE"/>
	
	    <result property="flightDuration" column="FLIGHT_DURATION"/>
	    <result property="tripType" column="FLIGHT_OFFER_ONE_WAY"/>
	
	    <result property="arriveDate" column="FLIGHT_ARRIVE_DATE"/>
	    <result property="arriveCity" column="ARRIVE_CITY"/>
	    <result property="arriveAirportCode" column="ARRIVE_CODE"/>
	
	    <result property="extraSeat" column="SEAT"/>
	    <result property="flightOfferId" column="FLIGHT_OFFER_ID"/>
	    <result property="totalPrice" column="FLIGHT_OFFER_PRICE_TOTAL"/>
	</resultMap>
	
	<resultMap id="WeeklyPriceResultMap" type="WeeklyPrice">
		<id column="DEPART_DATE" property="offerDepartDay"/>
		<result column="TOTAL_PRICE" property="offerPriceTotal"/>
	</resultMap>
  	
	<select id="selectAirlineListPrice" parameterType="AirlineFilter" resultMap="AirlineListResultMap">
	    /* 1. 가는 편 */
	     SELECT
	        al.AIRLINE_AIRLINE_NAME,
	        f.FLIGHT_DEPART_DATE,
	        f.FLIGHT_ARRIVE_DATE,
	        f.FLIGHT_DURATION,
	        f.FLIGHT_OFFER_ID,
	        f.FLIGHT_NUMBER AS FLIGHT_NUMBER,
	        dep.AIRPORT_CITY AS DEPART_CITY,
	        dep.AIRPORT_IATA_CODE AS DEPART_CODE,
	        arr.AIRPORT_CITY AS ARRIVE_CITY,
	        arr.AIRPORT_IATA_CODE AS ARRIVE_CODE,
	        offer.FLIGHT_OFFER_EXTRA_SEAT AS SEAT,
	        offer.FLIGHT_OFFER_ONE_WAY,
            offer.FLIGHT_OFFER_EXTRA_SEAT,
            history.FLIGHT_OFFER_PRICE_TOTAL
	    FROM TB_FLIGHT f
	    JOIN TB_AIRPORT dep ON f.DEPART_AIRPORT = dep.AIRPORT_IATA_CODE
	    JOIN TB_AIRPORT arr ON f.DEST_AIRPORT = arr.AIRPORT_IATA_CODE
	    JOIN TB_FLIGHT_OFFER offer ON offer.FLIGHT_OFFER_ID = f.FLIGHT_OFFER_ID
	    JOIN TB_AIRLINE al ON al.AIRLINE_ID = f.OPER_AIRLINE_ID
        JOIN TB_FLIGHT_PRICE_HISTORY history ON history.FLIGHT_OFFER_ID = f.FLIGHT_OFFER_ID
	    WHERE f.DEPART_AIRPORT = #{depart}
	      AND f.DEST_AIRPORT = #{arrive}
	      AND TRUNC(f.FLIGHT_DEPART_DATE) = TO_DATE(#{departDate}, 'YYYY-MM-DD')
	      AND offer.FLIGHT_OFFER_ONE_WAY = #{tripType}
	      AND f.FLIGHT_IS_DEL = 'N'
	
	
	    UNION ALL
	
	
	    /* 2. 오는 편 (나리타 -> 인천, 1/17) */
	    SELECT
	        al.AIRLINE_AIRLINE_NAME,
	        f.FLIGHT_DEPART_DATE,
	        f.FLIGHT_ARRIVE_DATE,
	        f.FLIGHT_DURATION,
	        f.FLIGHT_OFFER_ID,
	        f.FLIGHT_NUMBER AS FLIGHT_NUMBER,
	        dep.AIRPORT_CITY AS DEPART_CITY,
	        dep.AIRPORT_IATA_CODE AS DEPART_CODE,
	        arr.AIRPORT_CITY AS ARRIVE_CITY,
	        arr.AIRPORT_IATA_CODE AS ARRIVE_CODE,
	        offer.FLIGHT_OFFER_EXTRA_SEAT AS SEAT,
	        offer.FLIGHT_OFFER_ONE_WAY,
            offer.FLIGHT_OFFER_EXTRA_SEAT,
            history.FLIGHT_OFFER_PRICE_TOTAL
	    FROM TB_FLIGHT f
	    JOIN TB_AIRPORT dep ON f.DEPART_AIRPORT = dep.AIRPORT_IATA_CODE
	    JOIN TB_AIRPORT arr ON f.DEST_AIRPORT = arr.AIRPORT_IATA_CODE
	    JOIN TB_FLIGHT_OFFER offer ON offer.FLIGHT_OFFER_ID = f.FLIGHT_OFFER_ID
	    JOIN TB_AIRLINE al ON al.AIRLINE_ID = f.OPER_AIRLINE_ID
        JOIN TB_FLIGHT_PRICE_HISTORY history ON history.FLIGHT_OFFER_ID = f.FLIGHT_OFFER_ID
	    WHERE f.DEPART_AIRPORT = #{arrive}   /* 출발/도착 반전 */
	      AND f.DEST_AIRPORT = #{depart}    /* 출발/도착 반전 */
	      AND TRUNC(f.FLIGHT_DEPART_DATE) = TO_DATE(#{returnDate}, 'YYYY-MM-DD')
	      AND f.FLIGHT_IS_DEL = 'N'
	      AND offer.FLIGHT_OFFER_ONE_WAY = #{tripType}
	    ORDER BY FLIGHT_OFFER_PRICE_TOTAL asc
	</select>
	
	
	<!-- 비행시간순 정렬 -->
	<select id="selectAirlineListDuration" parameterType="AirlineFilter" resultMap="AirlineListResultMap">
	    SELECT * FROM (
	        /* 1. 가는 편 */
	        SELECT
	            al.AIRLINE_AIRLINE_NAME,
	            f.FLIGHT_DEPART_DATE,
	            f.FLIGHT_ARRIVE_DATE,
	            f.FLIGHT_DURATION,
	            f.FLIGHT_OFFER_ID,
	            dep.AIRPORT_CITY AS DEPART_CITY,
	            dep.AIRPORT_IATA_CODE AS DEPART_CODE,
	            arr.AIRPORT_CITY AS ARRIVE_CITY,
	            arr.AIRPORT_IATA_CODE AS ARRIVE_CODE,
	            offer.FLIGHT_OFFER_EXTRA_SEAT AS SEAT,
	            offer.FLIGHT_OFFER_ONE_WAY,
	            history.FLIGHT_OFFER_PRICE_TOTAL
	        FROM TB_FLIGHT f
	        JOIN TB_AIRPORT dep ON f.DEPART_AIRPORT = dep.AIRPORT_IATA_CODE
	        JOIN TB_AIRPORT arr ON f.DEST_AIRPORT = arr.AIRPORT_IATA_CODE
	        JOIN TB_FLIGHT_OFFER offer ON offer.FLIGHT_OFFER_ID = f.FLIGHT_OFFER_ID
	        JOIN TB_AIRLINE al ON al.AIRLINE_ID = f.OPER_AIRLINE_ID
	        JOIN TB_FLIGHT_PRICE_HISTORY history ON history.FLIGHT_OFFER_ID = f.FLIGHT_OFFER_ID
	        WHERE f.DEPART_AIRPORT = #{depart}
	          AND f.DEST_AIRPORT = #{arrive}
	          AND TRUNC(f.FLIGHT_DEPART_DATE) = #{departDate}
	          AND offer.FLIGHT_OFFER_ONE_WAY = #{tripType}
	          AND f.FLIGHT_IS_DEL = 'N'
	
	        UNION ALL
	
	        /* 2. 오는 편 */
	        SELECT
	            al.AIRLINE_AIRLINE_NAME,
	            f.FLIGHT_DEPART_DATE,
	            f.FLIGHT_ARRIVE_DATE,
	            f.FLIGHT_DURATION,
	            f.FLIGHT_OFFER_ID,
	            dep.AIRPORT_CITY AS DEPART_CITY,
	            dep.AIRPORT_IATA_CODE AS DEPART_CODE,
	            arr.AIRPORT_CITY AS ARRIVE_CITY,
	            arr.AIRPORT_IATA_CODE AS ARRIVE_CODE,
	            offer.FLIGHT_OFFER_EXTRA_SEAT AS SEAT,
	            offer.FLIGHT_OFFER_ONE_WAY,
	            history.FLIGHT_OFFER_PRICE_TOTAL
	        FROM TB_FLIGHT f
	        JOIN TB_AIRPORT dep ON f.DEPART_AIRPORT = dep.AIRPORT_IATA_CODE
	        JOIN TB_AIRPORT arr ON f.DEST_AIRPORT = arr.AIRPORT_IATA_CODE
	        JOIN TB_FLIGHT_OFFER offer ON offer.FLIGHT_OFFER_ID = f.FLIGHT_OFFER_ID
	        JOIN TB_AIRLINE al ON al.AIRLINE_ID = f.OPER_AIRLINE_ID
	        JOIN TB_FLIGHT_PRICE_HISTORY history ON history.FLIGHT_OFFER_ID = f.FLIGHT_OFFER_ID
	        WHERE f.DEPART_AIRPORT = #{arrive}
	          AND f.DEST_AIRPORT = #{depart}
	          AND TRUNC(f.FLIGHT_DEPART_DATE) = #{returnDate}
	          AND offer.FLIGHT_OFFER_ONE_WAY = #{tripType}
	          AND f.FLIGHT_IS_DEL = 'N'
	    )
	    ORDER BY
	        /* ISO 8601 Duration(PT2H20M)을 숫자로 변환하여 정렬 */
	        TO_NUMBER(NVL(REGEXP_SUBSTR(FLIGHT_DURATION, '(\d+)H', 1, 1, 'i', 1), 0)) * 60 +
	        TO_NUMBER(NVL(REGEXP_SUBSTR(FLIGHT_DURATION, '(\d+)M', 1, 1, 'i', 1), 0)) ASC
	</select>
	
	<!-- 늦은 출발순 -->
	<select id="selectAirlineListLate" parameterType="AirlineFilter" resultMap="AirlineListResultMap">
	    /* 1. 가는 편 */
	     SELECT
	        al.AIRLINE_AIRLINE_NAME,
	        f.FLIGHT_DEPART_DATE,
	        f.FLIGHT_ARRIVE_DATE,
	        f.FLIGHT_DURATION,
	        f.FLIGHT_OFFER_ID,
	        dep.AIRPORT_CITY AS DEPART_CITY,
	        dep.AIRPORT_IATA_CODE AS DEPART_CODE,
	        arr.AIRPORT_CITY AS ARRIVE_CITY,
	        arr.AIRPORT_IATA_CODE AS ARRIVE_CODE,
	        offer.FLIGHT_OFFER_EXTRA_SEAT AS SEAT,
	        offer.FLIGHT_OFFER_ONE_WAY,
            offer.FLIGHT_OFFER_EXTRA_SEAT,
            history.FLIGHT_OFFER_PRICE_TOTAL
	    FROM TB_FLIGHT f
	    JOIN TB_AIRPORT dep ON f.DEPART_AIRPORT = dep.AIRPORT_IATA_CODE
	    JOIN TB_AIRPORT arr ON f.DEST_AIRPORT = arr.AIRPORT_IATA_CODE
	    JOIN TB_FLIGHT_OFFER offer ON offer.FLIGHT_OFFER_ID = f.FLIGHT_OFFER_ID
	    JOIN TB_AIRLINE al ON al.AIRLINE_ID = f.OPER_AIRLINE_ID
        JOIN TB_FLIGHT_PRICE_HISTORY history ON history.FLIGHT_OFFER_ID = f.FLIGHT_OFFER_ID
	    WHERE f.DEPART_AIRPORT = #{depart}
	      AND f.DEST_AIRPORT = #{arrive}
	      AND TRUNC(f.FLIGHT_DEPART_DATE) = TO_DATE(#{departDate}, 'YYYY-MM-DD')
	      AND offer.FLIGHT_OFFER_ONE_WAY = #{tripType}
	      AND f.FLIGHT_IS_DEL = 'N'
	
	
	    UNION ALL
	
	
	    /* 2. 오는 편 (나리타 -> 인천, 1/17) */
	    SELECT
	        al.AIRLINE_AIRLINE_NAME,
	        f.FLIGHT_DEPART_DATE,
	        f.FLIGHT_ARRIVE_DATE,
	        f.FLIGHT_DURATION,
	        f.FLIGHT_OFFER_ID,
	        dep.AIRPORT_CITY AS DEPART_CITY,
	        dep.AIRPORT_IATA_CODE AS DEPART_CODE,
	        arr.AIRPORT_CITY AS ARRIVE_CITY,
	        arr.AIRPORT_IATA_CODE AS ARRIVE_CODE,
	        offer.FLIGHT_OFFER_EXTRA_SEAT AS SEAT,
	        offer.FLIGHT_OFFER_ONE_WAY,
            offer.FLIGHT_OFFER_EXTRA_SEAT,
            history.FLIGHT_OFFER_PRICE_TOTAL
	    FROM TB_FLIGHT f
	    JOIN TB_AIRPORT dep ON f.DEPART_AIRPORT = dep.AIRPORT_IATA_CODE
	    JOIN TB_AIRPORT arr ON f.DEST_AIRPORT = arr.AIRPORT_IATA_CODE
	    JOIN TB_FLIGHT_OFFER offer ON offer.FLIGHT_OFFER_ID = f.FLIGHT_OFFER_ID
	    JOIN TB_AIRLINE al ON al.AIRLINE_ID = f.OPER_AIRLINE_ID
        JOIN TB_FLIGHT_PRICE_HISTORY history ON history.FLIGHT_OFFER_ID = f.FLIGHT_OFFER_ID
	    WHERE f.DEPART_AIRPORT = #{arrive}   /* 출발/도착 반전 */
	      AND f.DEST_AIRPORT = #{depart}    /* 출발/도착 반전 */
	      AND TRUNC(f.FLIGHT_DEPART_DATE) = TO_DATE(#{returnDate}, 'YYYY-MM-DD')
	      AND offer.FLIGHT_OFFER_ONE_WAY = #{tripType}
	      AND f.FLIGHT_IS_DEL = 'N'
	    ORDER BY FLIGHT_DEPART_DATE DESC
	</select>
	
	
	<!-- 주간 가격 정보 -->
	<select id="selectWeeklyPrice" parameterType="AirlineFilter" resultMap="WeeklyPriceResultMap">
	  SELECT
	       TO_CHAR(FLIGHT_OFFER_DEPART_DATE, 'YYYY-MM-DD') AS DEPART_DATE,
	       MIN(FLIGHT_OFFER_PRICE_TOTAL) AS TOTAL_PRICE
	  FROM
	       TB_FLIGHT_PRICE_HISTORY history
	       JOIN TB_FLIGHT f ON history.FLIGHT_OFFER_ID = f.FLIGHT_OFFER_ID
	  WHERE FLIGHT_OFFER_ONE_WAY = #{tripType}
	    AND DEPART_IATA_CODE = #{depart}
	    AND ARRIVE_IATA_CODE = #{arrive}
	    AND f.FLIGHT_IS_DEL = 'N'
	    AND FLIGHT_OFFER_DEPART_DATE BETWEEN TO_DATE(#{departDate}, 'YYYY-MM-DD') -3
	                                     AND TO_DATE(#{departDate}, 'YYYY-MM-DD') +4
	  GROUP BY FLIGHT_OFFER_DEPART_DATE
	</select>
  </mapper>