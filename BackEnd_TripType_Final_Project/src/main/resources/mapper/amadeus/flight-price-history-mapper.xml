<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="flightPriceHistoryMapper">

    <!-- =========================================
         ðŸ”¥ FlightSearchCacheVo ResultMap
         ========================================= -->
    <resultMap id="flightSearchCacheMap"
               type="com.kh.triptype.admin.pricing.model.vo.FlightSearchCacheVo">

        <id property="flightPriceHistoryNo"
            column="FLIGHT_PRICE_HISTORY_NO"/>

        <result property="flightOfferId"
                column="FLIGHT_OFFER_ID"/>
        <result property="flightOfferPriceTotal"
                column="FLIGHT_OFFER_PRICE_TOTAL"/>
        <result property="flightOfferCurrency"
                column="FLIGHT_OFFER_CURRENCY"/>
        <result property="flightOfferOneWay"
                column="FLIGHT_OFFER_ONE_WAY"/>
        <result property="flightOfferDepartDate"
                column="FLIGHT_OFFER_DEPART_DATE"/>
        <result property="flightOfferReturnDate"
                column="FLIGHT_OFFER_RETURN_DATE"/>
        <result property="flightOfferApiQueryDate"
                column="FLIGHT_OFFER_API_QUERY_DATE"/>

        <result property="departIataCode"
                column="DEPART_IATA_CODE"/>
        <result property="arriveIataCode"
                column="ARRIVE_IATA_CODE"/>
        <result property="airlineId"
                column="AIRLINE_ID"/>

    </resultMap>

    <!-- =========================================
         1ï¸âƒ£ 1ì‹œê°„ ì´ë‚´ ê²€ìƒ‰ ìºì‹œ ì¡°íšŒ
         âœ… ìˆ˜ì • í¬ì¸íŠ¸
           1) ë‚ ì§œ ë¹„êµëŠ” TRUNCë¡œ í†µì¼(ì‹œê°„ê°’ ì„žì—¬ë„ ì•ˆì „)
           2) íŽ¸ë„/ì™•ë³µ êµ¬ë¶„ì€ chooseë¡œ ë‹¨ì¼í™”
           3) departDateê°€ nullì´ë©´ ORA-01858 ê°™ì€ ì˜¤ë¥˜ ê°€ëŠ¥ â†’ ì„œë¹„ìŠ¤ì—ì„œ ë§‰ëŠ” ê²Œ ë² ìŠ¤íŠ¸ì§€ë§Œ
              ë§¤í¼ëŠ” ê·¸ëŒ€ë¡œ ë‘ë˜ ë¹„êµëŠ” ì•ˆì „í•˜ê²Œ ìœ ì§€
         ========================================= -->
    <select id="selectRecentSearchCache"
            parameterType="com.kh.triptype.admin.pricing.model.dto.FlightSearchRequestDto"
            resultMap="flightSearchCacheMap">

        SELECT
            FLIGHT_PRICE_HISTORY_NO,
            FLIGHT_OFFER_ID,
            FLIGHT_OFFER_PRICE_TOTAL,
            FLIGHT_OFFER_CURRENCY,
            FLIGHT_OFFER_ONE_WAY,
            FLIGHT_OFFER_DEPART_DATE,
            FLIGHT_OFFER_RETURN_DATE,
            FLIGHT_OFFER_API_QUERY_DATE,
            DEPART_IATA_CODE,
            ARRIVE_IATA_CODE,
            AIRLINE_ID
        FROM TB_FLIGHT_PRICE_HISTORY
        WHERE
            DEPART_IATA_CODE = #{depart, jdbcType=VARCHAR}
            AND ARRIVE_IATA_CODE = #{arrive, jdbcType=VARCHAR}
            AND TRUNC(FLIGHT_OFFER_DEPART_DATE) = TO_DATE(#{departDate, jdbcType=VARCHAR}, 'YYYY-MM-DD')

            <!-- ì™•ë³µì¼ ê²½ìš°ë§Œ ê·€êµ­ì¼ ì¡°ê±´ -->
            <if test="returnDate != null">
                AND TRUNC(FLIGHT_OFFER_RETURN_DATE) = TO_DATE(#{returnDate, jdbcType=VARCHAR}, 'YYYY-MM-DD')
            </if>

            <!-- íŽ¸ë„ / ì™•ë³µ êµ¬ë¶„ -->
            <choose>
                <when test="tripType == 'ONEWAY'">
                    AND FLIGHT_OFFER_ONE_WAY = 'Y'
                </when>
                <otherwise>
                    AND FLIGHT_OFFER_ONE_WAY = 'N'
                </otherwise>
            </choose>

            <!-- ðŸ”¥ 1ì‹œê°„ ì´ë‚´ ìºì‹œ -->
            AND FLIGHT_OFFER_API_QUERY_DATE >= SYSDATE - (1 / 24)

        ORDER BY FLIGHT_OFFER_API_QUERY_DATE DESC

    </select>

    <!-- =========================================
         2ï¸âƒ£ ê²€ìƒ‰ ìºì‹œ ì €ìž¥
         âœ… ìˆ˜ì • í¬ì¸íŠ¸
           1) jdbcType ëª…ì‹œ (NUMBER/DATE/TIMESTAMP/CHAR ì•ˆì •í™”)
         ========================================= -->
    <insert id="insertSearchCache"
            parameterType="com.kh.triptype.admin.pricing.model.vo.FlightSearchCacheVo">

        INSERT INTO TB_FLIGHT_PRICE_HISTORY (
            FLIGHT_PRICE_HISTORY_NO,
            FLIGHT_OFFER_ID,
            FLIGHT_OFFER_PRICE_TOTAL,
            FLIGHT_OFFER_CURRENCY,
            FLIGHT_OFFER_ONE_WAY,
            FLIGHT_OFFER_DEPART_DATE,
            FLIGHT_OFFER_RETURN_DATE,
            FLIGHT_OFFER_API_QUERY_DATE,
            DEPART_IATA_CODE,
            ARRIVE_IATA_CODE,
            AIRLINE_ID
        ) VALUES (
            TB_FLIGHT_PRICE_HISTORY_SEQ.NEXTVAL,
            #{flightOfferId, jdbcType=NUMERIC},
            #{flightOfferPriceTotal, jdbcType=NUMERIC},
            #{flightOfferCurrency, jdbcType=VARCHAR},
            #{flightOfferOneWay, jdbcType=CHAR},
            #{flightOfferDepartDate, jdbcType=DATE},
            #{flightOfferReturnDate, jdbcType=DATE},
            #{flightOfferApiQueryDate, jdbcType=TIMESTAMP},
            #{departIataCode, jdbcType=VARCHAR},
            #{arriveIataCode, jdbcType=VARCHAR},
            #{airlineId, jdbcType=INTEGER}
        )

    </insert>

</mapper>
