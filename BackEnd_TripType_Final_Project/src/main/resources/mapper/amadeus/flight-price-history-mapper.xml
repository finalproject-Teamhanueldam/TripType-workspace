<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "mybatis-3-mapper.dtd">

<mapper namespace="flightPriceHistoryMapper">

    <!-- =========================================
         1ï¸âƒ£ 1ì‹œê°„ ì´ë‚´ ê²€ìƒ‰ ìºì‹œ ì¡°íšŒ
         ========================================= -->
    <select id="selectRecentSearchCache"
            parameterType="com.kh.triptype.admin.pricing.model.dto.FlightSearchRequestDto"
            resultType="com.kh.triptype.admin.pricing.model.vo.FlightSearchCacheVo">

        SELECT
            FLIGHT_PRICE_HISTORY_NO,
            FLIGHT_OFFER_ID,
            FLIGHT_OFFER_PRICE_TOTAL,
            FLIGHT_OFFER_CURRENCY,
            FLIGHT_OFFER_ONE_WAY,
            FLIGHT_OFFER_DEPART_DATE,
            FLIGHT_OFFER_RETURN_DATE,
            FLIGHT_OFFER_API_QUERY_DATE,
            DEPART_IATA_CODE,
            ARRIVE_IATA_CODE,
            AIRLINE_ID
        FROM TB_FLIGHT_PRICE_HISTORY
        WHERE
            DEPART_IATA_CODE = #{depart}
            AND ARRIVE_IATA_CODE = #{arrive}
            AND FLIGHT_OFFER_DEPART_DATE = TO_DATE(#{departDate}, 'YYYY-MM-DD')

            <!-- ì™•ë³µì¼ ê²½ìš°ë§Œ ê·€êµ­ì¼ ì¡°ê±´ -->
            <if test="returnDate != null">
                AND FLIGHT_OFFER_RETURN_DATE = TO_DATE(#{returnDate}, 'YYYY-MM-DD')
            </if>

            <!-- íŽ¸ë„ / ì™•ë³µ êµ¬ë¶„ -->
            <if test="tripType == 'ONEWAY'">
                AND FLIGHT_OFFER_ONE_WAY = 'Y'
            </if>
            <if test="tripType != 'ONEWAY'">
                AND FLIGHT_OFFER_ONE_WAY = 'N'
            </if>

            <!-- ðŸ”¥ 1ì‹œê°„ ì´ë‚´ ìºì‹œ -->
            AND FLIGHT_OFFER_API_QUERY_DATE >= SYSDATE - (1 / 24)

        ORDER BY FLIGHT_OFFER_API_QUERY_DATE DESC

    </select>

    <!-- =========================================
         2ï¸âƒ£ ê²€ìƒ‰ ìºì‹œ ì €ìž¥
         ========================================= -->
    <insert id="insertSearchCache"
            parameterType="com.kh.triptype.admin.pricing.model.vo.FlightSearchCacheVo">

        INSERT INTO TB_FLIGHT_PRICE_HISTORY (
            FLIGHT_PRICE_HISTORY_NO,
            FLIGHT_OFFER_ID,
            FLIGHT_OFFER_PRICE_TOTAL,
            FLIGHT_OFFER_CURRENCY,
            FLIGHT_OFFER_ONE_WAY,
            FLIGHT_OFFER_DEPART_DATE,
            FLIGHT_OFFER_RETURN_DATE,
            FLIGHT_OFFER_API_QUERY_DATE,
            DEPART_IATA_CODE,
            ARRIVE_IATA_CODE,
            AIRLINE_ID
        ) VALUES (
            TB_FLIGHT_PRICE_HISTORY_SEQ.NEXTVAL,
            #{flightOfferId},
            #{flightOfferPriceTotal},
            #{flightOfferCurrency},
            #{flightOfferOneWay},
            #{flightOfferDepartDate},
            #{flightOfferReturnDate},
            #{flightOfferApiQueryDate},
            #{departIataCode},
            #{arriveIataCode},
            #{airlineId}
        )

    </insert>

</mapper>
