<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
  PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
  "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.kh.triptype.notice.dao.NoticeDao">

    <!-- ================= ê³µì§€ ëª©ë¡ ì „ìš© ResultMap (ì²¨ë¶€ âŒ) ================= -->
    <resultMap id="noticeListResultMap"
	           type="com.kh.triptype.notice.model.vo.Notice">
	    <id     property="noticeId"          column="NOTICE_ID"/>
	    <result property="noticeTitle"       column="NOTICE_TITLE"/>
	    <result property="noticeContent"     column="NOTICE_CONTENT"/>
	    <result property="noticeCreatedAt"   column="NOTICE_CREATED_AT"/>
	    <result property="noticeUpdatedAt"   column="NOTICE_UPDATED_AT"/>
	    <result property="noticeViews"       column="NOTICE_VIEWS"/>
	    <result property="noticeIsImportant" column="NOTICE_IS_IMPORTANT"/>
	    <result property="noticeIsDel"       column="NOTICE_IS_DEL"/>
	</resultMap>

    <!-- ================= ê³µì§€ ìƒì„¸ ì „ìš© ResultMap (ì²¨ë¶€ â­•) ================= -->
	<resultMap id="noticeDetailResultMap" type="com.kh.triptype.notice.model.vo.Notice">
	    <id     property="noticeId"          column="NOTICE_ID"/>
	    <result property="noticeTitle"       column="NOTICE_TITLE"/>
	    <result property="noticeContent"     column="NOTICE_CONTENT"/>
	    <result property="noticeCreatedAt"   column="NOTICE_CREATED_AT"/>
	    <result property="noticeUpdatedAt"   column="NOTICE_UPDATED_AT"/>
	    <result property="noticeViews"       column="NOTICE_VIEWS"/>
	    <result property="noticeIsImportant" column="NOTICE_IS_IMPORTANT"/>
	    <result property="noticeIsDel"       column="NOTICE_IS_DEL"/>
	
	    <collection property="attachmentList" ofType="com.kh.triptype.notice.model.vo.Attachment">
	        <id     property="noticeAttachmentId" column="NOTICE_ATTACHMENT_ID"/>
	        <result property="noticeAttachmentName" column="NOTICE_ATTACHMENT_NAME"/>
	        <result property="noticeAttachmentUpdate" column="NOTICE_ATTACHMENT_UPDATE"/>
	        <result property="noticeAttachmentUrl" column="NOTICE_ATTACHMENT_URL"/>
	        <result property="noticeAttachmentUploadedAt" column="NOTICE_ATTACHMENT_UPLOADED_AT"/>
	        <result property="noticeAttachmentIsDel" column="NOTICE_ATTACHMENT_IS_DEL"/>
	        <result property="noticeId" column="NOTICE_ID"/>
	    </collection>
	</resultMap>

    <!-- ================= ì²¨ë¶€íŒŒì¼ ResultMap ================= -->
    <resultMap id="attachmentResultMap"
               type="com.kh.triptype.notice.model.vo.Attachment">
        <id     property="noticeAttachmentId" column="NOTICE_ATTACHMENT_ID"/>
        <result property="noticeAttachmentName" column="NOTICE_ATTACHMENT_NAME"/>
        <result property="noticeAttachmentUpdate" column="NOTICE_ATTACHMENT_UPDATE"/>
        <result property="noticeAttachmentUrl" column="NOTICE_ATTACHMENT_URL"/>
        <result property="noticeAttachmentUploadedAt" column="NOTICE_ATTACHMENT_UPLOADED_AT"/>
        <result property="noticeAttachmentIsDel" column="NOTICE_ATTACHMENT_IS_DEL"/>
        <result property="noticeId" column="NOTICE_ID"/>
    </resultMap>

    <!-- ================= ê³µì§€ ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ìž) ================= -->
	<!-- ================= ì‚¬ìš©ìž ê³µì§€ ëª©ë¡ ì¡°íšŒ ================= -->
	<select id="selectNoticeList"
	        parameterType="map"
	        resultMap="noticeListResultMap">
	    SELECT *
	    FROM (
	        SELECT
	            ROW_NUMBER() OVER (
	                ORDER BY NOTICE_IS_IMPORTANT DESC, NOTICE_CREATED_AT DESC
	            ) AS RN,
	            N.*
	        FROM TB_NOTICE N
	        WHERE NOTICE_IS_DEL = 'N'
	    )
	    WHERE RN BETWEEN #{startRow} AND #{endRow}
	</select>

		
	<!-- ================= ê³µì§€ ëª©ë¡ ì¡°íšŒ (ê´€ë¦¬ìž: ì‚­ì œ í¬í•¨) ================= -->
	<select id="selectNoticeListAdmin"
	        parameterType="map"
	        resultMap="noticeListResultMap">
	
	    SELECT *
		FROM (
		    SELECT
		        ROWNUM RN,
		        A.*
		    FROM (
		        SELECT *
		        FROM TB_NOTICE
		        <where>
		            <if test="showDeleted != null and showDeleted == &quot;N&quot;">
					    NOTICE_IS_DEL = 'N'
					</if>
		        </where>
		        ORDER BY NOTICE_ID DESC
		    ) A
		    WHERE ROWNUM &lt;= #{endRow}
		)
		WHERE RN &gt;= #{startRow}
	</select>

    <!-- ================= ê³µì§€ ìƒì„¸ ì¡°íšŒ ================= -->
	<select id="selectNoticeDetail" parameterType="long" resultMap="noticeDetailResultMap">
	    SELECT
	        N.NOTICE_ID,
	        N.NOTICE_TITLE,
	        N.NOTICE_CONTENT,
	        N.NOTICE_CREATED_AT,
	        N.NOTICE_UPDATED_AT,
	        N.NOTICE_VIEWS,
	        N.NOTICE_IS_IMPORTANT,
	        N.NOTICE_IS_DEL,
	        A.NOTICE_ATTACHMENT_ID,
	        A.NOTICE_ATTACHMENT_NAME,
	        A.NOTICE_ATTACHMENT_UPDATE,
	        A.NOTICE_ATTACHMENT_URL,
	        A.NOTICE_ATTACHMENT_UPLOADED_AT,
	        A.NOTICE_ATTACHMENT_IS_DEL
	    FROM TB_NOTICE N
	    LEFT JOIN TB_NOTICE_ATTACHMENT A ON (N.NOTICE_ID = A.NOTICE_ID AND A.NOTICE_ATTACHMENT_IS_DEL = 'N')
	    WHERE N.NOTICE_ID = #{noticeId}
	      AND N.NOTICE_IS_DEL = 'N'
	</select>
	
	<!-- ================= ê³µì§€ ë“±ë¡ ================= -->
    <insert id="insertNotice"
            parameterType="com.kh.triptype.notice.model.vo.Notice">
        <selectKey keyProperty="noticeId" resultType="long" order="BEFORE">
            SELECT TB_NOTICE_SEQ.NEXTVAL FROM DUAL
        </selectKey>

        INSERT INTO TB_NOTICE (
            NOTICE_ID,
            NOTICE_TITLE,
            NOTICE_CONTENT,
            NOTICE_CREATED_AT,
            NOTICE_UPDATED_AT,
            NOTICE_VIEWS,
            NOTICE_IS_IMPORTANT,
            NOTICE_IS_DEL
        ) VALUES (
            #{noticeId},
            #{noticeTitle},
            #{noticeContent},
            SYSDATE,
            SYSDATE,
            0,
            #{noticeIsImportant},
            'N'
        )
    </insert>


    <!-- ================= ê³µì§€ ìˆ˜ì • ================= -->
    <update id="updateNotice"
            parameterType="com.kh.triptype.notice.model.vo.Notice">
        UPDATE TB_NOTICE
        SET
            NOTICE_TITLE = #{noticeTitle},
            NOTICE_CONTENT = #{noticeContent},
            NOTICE_UPDATED_AT = SYSDATE,
            NOTICE_IS_IMPORTANT = #{noticeIsImportant}
        WHERE NOTICE_ID = #{noticeId}
          AND NOTICE_IS_DEL = 'N'
    </update>

    <!-- ================= ê³µì§€ ì‚­ì œ ================= -->
    <update id="deleteNotice" parameterType="long">
        UPDATE TB_NOTICE
        SET NOTICE_IS_DEL = 'Y'
        WHERE NOTICE_ID = #{noticeId}
    </update>

    <!-- ================= ðŸ”¥ ì²¨ë¶€íŒŒì¼ ì¶”ê°€ ë¶€ë¶„ ================= -->
    
    <!-- ================= ì²¨ë¶€íŒŒì¼ ì¡°íšŒ (ìƒì„¸ìš©) ================= -->
    <select id="selectAttachmentList"
            parameterType="map"
            resultMap="attachmentResultMap">
        SELECT
            NOTICE_ATTACHMENT_ID,
            NOTICE_ATTACHMENT_NAME,
            NOTICE_ATTACHMENT_UPDATE,
            NOTICE_ATTACHMENT_URL,
            NOTICE_ATTACHMENT_UPLOADED_AT,
            NOTICE_ATTACHMENT_IS_DEL,
            NOTICE_ID
        FROM TB_NOTICE_ATTACHMENT
        WHERE NOTICE_ID = #{noticeId}
          AND NOTICE_ATTACHMENT_IS_DEL = 'N'
        ORDER BY NOTICE_ATTACHMENT_ID
    </select>

	
	<select id="selectAttachmentListAdmin"
	        parameterType="long"
	        resultMap="attachmentResultMap">
	    SELECT
	        NOTICE_ATTACHMENT_ID,
	        NOTICE_ATTACHMENT_NAME,
	        NOTICE_ATTACHMENT_UPDATE,
	        NOTICE_ATTACHMENT_URL,
	        NOTICE_ATTACHMENT_UPLOADED_AT,
	        NOTICE_ATTACHMENT_IS_DEL,
	        NOTICE_ID
	    FROM TB_NOTICE_ATTACHMENT
	    WHERE NOTICE_ID = #{noticeId}
	      AND NOTICE_ATTACHMENT_IS_DEL = 'N'
	    ORDER BY NOTICE_ATTACHMENT_ID
	</select>

    <!-- ================= ì²¨ë¶€íŒŒì¼ ë“±ë¡ ================= -->
    <insert id="insertAttachment"
            parameterType="com.kh.triptype.notice.model.vo.Attachment">
        INSERT INTO TB_NOTICE_ATTACHMENT (
            NOTICE_ATTACHMENT_ID,
            NOTICE_ATTACHMENT_NAME,
            NOTICE_ATTACHMENT_UPDATE,
            NOTICE_ATTACHMENT_URL,
            NOTICE_ATTACHMENT_UPLOADED_AT,
            NOTICE_ATTACHMENT_IS_DEL,
            NOTICE_ID
        ) VALUES (
            TB_NOTICE_ATTACHMENT_SEQ.NEXTVAL,
            #{noticeAttachmentName},
            #{noticeAttachmentUpdate},
            #{noticeAttachmentUrl},
            SYSDATE,
            'N',
            #{noticeId}
        )
    </insert>
    
    <!-- ================= ì²¨ë¶€íŒŒì¼ ì‚­ì œ ================= -->
    <update id="deleteAttachment" parameterType="map">
        UPDATE TB_NOTICE_ATTACHMENT
        SET NOTICE_ATTACHMENT_IS_DEL = 'Y'
        WHERE NOTICE_ATTACHMENT_ID IN
        <foreach collection="deletedFileIds" item="id"
                 open="(" separator="," close=")">
            #{id}
        </foreach>
    </update>

    <update id="deleteAttachmentByNotice" parameterType="long">
        UPDATE TB_NOTICE_ATTACHMENT
        SET NOTICE_ATTACHMENT_IS_DEL = 'Y'
        WHERE NOTICE_ID = #{noticeId}
    </update>
    
    <!-- ================= ì¡°íšŒìˆ˜ ì¦ê°€ ================= -->
    <update id="increaseViews" parameterType="map">
        UPDATE TB_NOTICE
        SET NOTICE_VIEWS = NOTICE_VIEWS + 1
        WHERE NOTICE_ID = #{noticeId}
          AND NOTICE_IS_DEL = 'N'
    </update>
    
    <!-- ================= íŽ˜ì´ì§• ================= -->
    <select id="selectNoticeCount" resultType="int">
	    SELECT COUNT(*)
	    FROM TB_NOTICE
	    WHERE NOTICE_IS_DEL = 'N'
	</select>
	
	<select id="selectNoticeCountAdmin" resultType="int">
	    SELECT COUNT(*)
	    FROM TB_NOTICE
	    <where>
	        <if test='showDeleted == "N"'>
	            NOTICE_IS_DEL = 'N'
	        </if>
	    </where>
	</select>




</mapper>
